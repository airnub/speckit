name: speckit-verify
on:
  pull_request:
  push:
    branches: [main]
jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'pnpm' }
      - run: corepack enable
      - run: pnpm install --frozen-lockfile || true
      - run: pnpm -w -r build || true
      - name: Build Speckit Core
        run: pnpm --filter @speckit/core run build
      - name: Build Speckit CLI
        run: pnpm --filter @speckit/cli run build
      - name: Regenerate docs from spec
        run: node packages/speckit-cli/dist/cli.js gen --write
      - name: Audit generated docs
        run: node packages/speckit-cli/dist/cli.js audit
      - name: Fail if generated docs drift
        run: git diff --exit-code || (echo "Generated docs drift detected. Run 'speckit gen --write' and commit." && exit 1)
